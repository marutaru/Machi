// Generated by CoffeeScript 1.7.1
(function() {
  $(function() {
    var flag, lat, long, map, mapInit, markerManager, moveMarker, myMarker, newMarker, opt, roomName, socket;
    lat = null;
    long = null;
    roomName = null;
    map = null;
    markerManager = [];
    myMarker = null;
    flag = false;
    $("#update").hide();
    opt = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    };
    navigator.geolocation.watchPosition(function(position) {
      var info;
      lat = position.coords.latitude;
      long = position.coords.longitude;
      $("#lat").val(lat);
      $("#long").val(long);
      info = {
        "name": $("#username").val(),
        "aikotoba": $("#aikotoba").val(),
        "lat": lat,
        "long": long
      };
      if (flag === true) {
        moveMarker(info, myMarker);
        return socket.emit("update", info);
      }
    }, function(error) {
      return console.log(error);
    }, opt);
    socket = io.connect("http://localhost:3000");
    mapInit = function() {
      var option;
      option = {
        "center": new google.maps.LatLng(lat, long),
        "zoom": 12,
        "mapTypeId": google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map($("#map_canvas").get(0), option);
      return console.log("initilized maps");
    };
    $("#join").click(function(event) {
      var latlng, my, name;
      flag = true;
      lat = $("#lat").val();
      long = $("#long").val();
      name = $("#username").val();
      my = {
        "name": name,
        "aikotoba": $("#aikotoba").val(),
        "lat": lat,
        "long": long
      };
      console.log("click" + my.name);
      mapInit();
      latlng = new google.maps.LatLng(lat, long);
      myMarker = new google.maps.Marker({
        "position": latlng,
        "map": map,
        "title": name
      });
      socket.emit("join", my);
      $(this).hide();
      return $("#update").show();
    });
    $("#update").click(function(event) {
      var info;
      console.log("update");
      lat = $("#lat").val();
      long = $("#long").val();
      info = {
        "name": $("#username").val(),
        "aikotoba": $("#aikotoba").val(),
        "lat": lat,
        "long": long
      };
      moveMarker(info, myMarker);
      return socket.emit("update", info);
    });
    socket.on("data", function(data) {
      var info, latlng, oldMarker;
      console.log("data update");
      roomName = data.aikotoba;
      latlng = new google.maps.LatLng(data.lat, data.long);
      if (oldMarker = _.findWhere(markerManager, {
        "title": data.name
      })) {
        return moveMarker(data, oldMarker);
      } else {
        newMarker(data);
        info = {
          "name": $("#username").val(),
          "aikotoba": $("#aikotoba").val(),
          "lat": lat,
          "long": long
        };
        return socket.emit("update", info);
      }
    });
    newMarker = function(data) {
      var latlng, marker;
      latlng = new google.maps.LatLng(data.lat, data.long);
      marker = new google.maps.Marker({
        "position": latlng,
        "map": map,
        "title": data.name
      });
      return markerManager.push(marker);
    };
    return moveMarker = function(data, marker) {
      var latlng;
      console.log("moveMarker");
      console.log(marker);
      latlng = new google.maps.LatLng(data.lat, data.long);
      marker.position = latlng;
      return marker.setMap(map);
    };
  });

}).call(this);
